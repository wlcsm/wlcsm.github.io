<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
</head>
<body><nav>
    
    	<a class="menu-item" href="/">About</a>

    
    	<a class="menu-item" href="/posts/">Posts</a>

    
    	<a class="menu-item" href="/tags/">Tags</a>

    
    	<a class="menu-item" href="/resume/">Resume</a>

    

    
</nav>
<div id="content">
<h1>Neovim Async Jobs (No Plugins)</h1>


<time datetime="2021-11-06">Nov 6, 2021</time>


	
	<a href="http://example.org/tags/vim">vim</a>



<br><br>
<p>Neovim introduced asynchronous job control which load to plugins enabling you to run shell commands without blocking Vim, most notably the fantastic (<a href="https://github.com/neomake/neomake">Neomake</a>) plugin. For my development however, I only really need to run shell commands asynchronously and load the data into the quickfix list.</p>
<p>Neomake is great, but it&rsquo;s also 13000+ lines of code, this is one:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-vim" data-lang="vim"><span class="line"><span class="cl"><span class="nx">command</span><span class="p">!</span> <span class="p">-</span><span class="nx">nargs</span><span class="p">=+</span> <span class="nx">AsyncRun</span> <span class="nx">call</span> <span class="nx">jobstart</span><span class="p">(</span>[<span class="s1">&#39;sh&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;args&gt; &gt; /tmp/run.log 2&gt;&amp;1&#39;</span>]<span class="p">,</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>	\ {<span class="s1">&#39;on_exit&#39;</span>: {<span class="p">-&gt;</span> <span class="nx">execute</span><span class="p">(</span><span class="s1">&#39;cfile /tmp/run.log&#39;</span><span class="p">)</span>}}<span class="p">)</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li><code>command! -nargs=+ Run</code> - Define a command called &lsquo;Run&rsquo; which must be given at least one argument</li>
<li><code>call jobstart</code>
<ul>
<li><code>['sh', '-c', '&lt;args&gt; &gt; /tmp/run.log 2&gt;&amp;1']</code> - Execute the arguments of the command and redirect the output to <code>/tmp/run.log</code></li>
<li><code>{'on_exit': {-&gt; execute('cfile /tmp/run.log')}})</code> - When the program exits, load the file <code>/tmp/run.log</code> into the quickfix list</li>
</ul>
</li>
</ol>
<p>Now <code>:call AsyncRun('go build')</code> will run <code>go build</code> in the shell asyncrohnously and load the errors in the quickfix list. It you find that you can&rsquo;t jump to the errors, make sure the <code>errorformat</code> variable is set correctly. For example if you were to run <code>go build</code> you should set your compiler to <code>go</code> with <code>compiler go</code>.</p>
<p>There is one problem with this: since we are writing to the same file every time, running multiple commands at once will cause problems, but this is something that I don&rsquo;t really need at the moment and could be easily added later (an example is given at the end)</p>
<h2 id="extensions">Extensions</h2>
<p>This is pretty sufficent for my needs by it could be extended in many ways. Here are a couple of fairly common quality-of-life improvements. First, a quick refactor it to make it easier to add changes</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-vim" data-lang="vim"><span class="line"><span class="cl"><span class="k">let</span> <span class="nx">s</span>:<span class="nx">logfile</span> <span class="p">=</span> <span class="s1">&#39;/tmp/run.log&#39;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">function</span> <span class="nx">AsyncRun</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span> <span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>	<span class="nx">return</span> <span class="nx">call</span> <span class="nx">jobstart</span><span class="p">(</span>[<span class="s1">&#39;sh&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="nx">a</span>:<span class="nx">cmd</span> . <span class="s1">&#39; &gt; &#39;</span> . <span class="nx">s</span>:<span class="nx">logfile</span> . <span class="s1">&#39; 2&gt;&amp;1&#39;</span>]<span class="p">,</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>		\ {<span class="s1">&#39;on_exit&#39;</span>: <span class="k">function</span><span class="p">(</span><span class="s1">&#39;s:OnExit&#39;</span><span class="p">)</span>}<span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">endfunction</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">function</span> <span class="nx">s</span>:<span class="nx">OnExit</span><span class="p">()</span> <span class="nx">dict</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>	<span class="nx">execute</span> <span class="s1">&#39;cfile &#39;</span> . <span class="nx">s</span>:<span class="nx">logfile</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">endfunction</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="open-the-quickfix-list-if-errors-exist">Open the quickfix list if errors exist</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-vim" data-lang="vim"><span class="line"><span class="cl"><span class="k">function</span> <span class="nx">s</span>:<span class="nx">OnExit</span><span class="p">()</span> <span class="nx">dict</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c">	&#34; ... rest of code</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>	<span class="nx">cwindow</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">endfunction</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="print-a-message-if-there-arent-any-messages">Print a message if there aren&rsquo;t any messages</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-vim" data-lang="vim"><span class="line"><span class="cl"><span class="k">function</span> <span class="nx">s</span>:<span class="nx">OnExit</span><span class="p">()</span> <span class="nx">dict</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c">	&#34; ... rest of code</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>	<span class="k">if</span> <span class="nx">len</span><span class="p">(</span><span class="nx">getqflist</span><span class="p">())</span> <span class="p">==</span> <span class="m">0</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>		<span class="nx">echom</span> <span class="s2">&#34;Finished&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>	<span class="k">endif</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">endfunction</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="managing-multiple-asynchronous-tasks">Managing multiple asynchronous tasks</h3>
<p>The <code>jobstart</code> function returns a job id which you can use to keep track of it. We could change the function to not allow you to run the same command while the previous command is still running.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-vim" data-lang="vim"><span class="line"><span class="cl"><span class="k">let</span> <span class="nx">s</span>:<span class="nx">jobs</span> <span class="p">=</span> {}<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">let</span> <span class="nx">s</span>:<span class="nx">logfile</span> <span class="p">=</span> <span class="s1">&#39;/tmp/run&#39;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">let</span> <span class="nx">s</span>:<span class="nx">num</span> <span class="p">=</span> <span class="m">0</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c">
</span></span></span><span class="line"><span class="cl"><span class="c">&#34; Submit a job into the dictionary</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">function</span><span class="p">!</span> <span class="nx">AsyncRun</span><span class="p">(</span><span class="nx">cmd</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>	<span class="k">if</span> <span class="nx">has_key</span><span class="p">(</span><span class="nx">s</span>:<span class="nx">jobs</span><span class="p">,</span> <span class="nx">a</span>:<span class="nx">cmd</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>		<span class="nx">echo</span> <span class="s2">&#34;Job &#39;&#34;</span> . <span class="nx">a</span>:<span class="nx">cmd</span> . <span class="s2">&#34;&#39; is already running!&#34;</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>	<span class="k">else</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>		<span class="k">let</span> <span class="nx">s</span>:<span class="nx">num</span> <span class="p">+=</span> <span class="m">1</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>		<span class="k">let</span> <span class="nx">outfile</span> <span class="p">=</span> <span class="nx">s</span>:<span class="nx">logfile</span> . <span class="nx">s</span>:<span class="nx">num</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>		<span class="k">let</span> <span class="nx">id</span> <span class="p">=</span> <span class="nx">jobstart</span><span class="p">(</span>[<span class="s1">&#39;sh&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="nx">a</span>:<span class="nx">cmd</span> . <span class="s1">&#39; &gt; &#39;</span> . <span class="nx">outfile</span> . <span class="s1">&#39; 2&gt;&amp;1&#39;</span>]<span class="p">,</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>			\ {<span class="s1">&#39;on_exit&#39;</span>: <span class="k">function</span><span class="p">(</span><span class="s1">&#39;s:OnExit&#39;</span><span class="p">)</span>}<span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>		<span class="k">let</span> <span class="nx">s</span>:<span class="nx">jobs</span>[<span class="nx">a</span>:<span class="nx">cmd</span>] <span class="p">=</span> [<span class="nx">id</span><span class="p">,</span> <span class="nx">s</span>:<span class="nx">logfile</span> . <span class="nx">s</span>:<span class="nx">num</span>]<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>	<span class="k">endif</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">endfunction</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">function</span><span class="p">!</span> <span class="nx">s</span>:<span class="nx">OnExit</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">event</span><span class="p">)</span> <span class="nx">dict</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>	<span class="k">let</span> <span class="nx">cmd</span>  <span class="p">=</span> <span class="nx">filter</span><span class="p">(</span><span class="nx">items</span><span class="p">(</span><span class="nx">s</span>:<span class="nx">jobs</span><span class="p">),</span> {<span class="nx">i</span><span class="p">,</span><span class="nx">v</span> <span class="p">-&gt;</span> <span class="nx">v</span>[<span class="m">1</span>][<span class="m">0</span>] <span class="p">==</span> <span class="nx">a</span>:<span class="nx">id</span>}<span class="p">)</span>[<span class="m">0</span>][<span class="m">0</span>]<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>	<span class="nx">execute</span> <span class="s1">&#39;cfile &#39;</span> . <span class="nx">s</span>:<span class="nx">jobs</span>[<span class="nx">cmd</span>][<span class="m">1</span>]<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c">
</span></span></span><span class="line"><span class="cl"><span class="c">	&#34; ... rest of code</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c">
</span></span></span><span class="line"><span class="cl"><span class="c">	&#34; Delete the log file and remove the job from the dictionary</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>	<span class="nx">call</span> <span class="nx">system</span><span class="p">(</span><span class="s1">&#39;rm &#39;</span> . <span class="nx">s</span>:<span class="nx">jobs</span>[<span class="nx">cmd</span>][<span class="m">1</span>]<span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>	<span class="nx">call</span> <span class="nx">remove</span><span class="p">(</span><span class="nx">s</span>:<span class="nx">jobs</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">endfunction</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">function</span><span class="p">!</span> <span class="nx">PrintJobs</span><span class="p">()</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>	<span class="nx">for</span> [<span class="nx">key</span><span class="p">,</span> <span class="nx">value</span>] <span class="nx">in</span> <span class="nx">items</span><span class="p">(</span><span class="nx">s</span>:<span class="nx">jobs</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>		<span class="nx">echo</span> <span class="nx">value</span>[<span class="m">0</span>] . <span class="s1">&#39;: &#39;</span> . <span class="nx">key</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span>	<span class="nx">endfor</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">endfunction</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>This also added the <code>PrintJobs()</code> function to print all the running jobs</p>
<p>This doesn&rsquo;t even include things like stopping jobs prematurely, and we haven&rsquo;t even touched the <code>on_stdin</code> and <code>on_stderr</code> callbacks for the <code>jobstart</code> function. At the moment, I&rsquo;ve found our original one line function along with printing the result when finished to be all I want for now.</p>


        </div>
	<hr><p class="footer">
Copyright Will Cashman 2022.
<br>
Any and all opinions listed here are my own and not representative of my employers; future, past and present.
</p>

</body>
</html>
